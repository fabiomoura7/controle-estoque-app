<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Estoque</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .menu { margin-bottom: 20px; }
    .menu button { margin-right: 10px; }
    .guia { display: none; }
    .ativa { display: block; }
    input, select, button { margin: 5px 0; display: block; }
    .produto, .local { margin: 5px 0; }
    pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>

  <div class="menu">
    <button onclick="mostrarGuia('produtos')">Produtos</button>
    <button onclick="mostrarGuia('locais')">Locais</button>
    <button onclick="mostrarGuia('movimentacao')">Movimentação</button>
    <button onclick="mostrarGuia('estoque')">Estoque</button>
    <button onclick="mostrarGuia('relatorio')">Relatório</button>
    <button onclick="exportarDados()">Exportar Dados</button>
    <input type="file" id="importarArquivo" accept=".json" onchange="importarDados()" style="display: none;">
    <button onclick="document.getElementById('importarArquivo').click()">Importar Dados</button>
  </div>

  <div id="produtos" class="guia">
    <h2>Cadastro de Produto</h2>
    <input id="codigoProduto" placeholder="Código do Produto" />
    <input id="nomeProduto" placeholder="Nome do Produto" />
    <input id="quantidadeInicial" type="number" placeholder="Estoque Inicial" min="0" />
    <select id="localInicial"></select>
    <button onclick="cadastrarProduto()">Cadastrar Produto</button>
    <div id="listaProdutos"></div>
  </div>

  <div id="locais" class="guia">
    <h2>Cadastro de Locais</h2>
    <input id="nomeLocal" placeholder="Nome do Local" />
    <input id="enderecoLocal" placeholder="Endereço ou Código do Local" />
    <button onclick="cadastrarLocal()">Cadastrar Local</button>
    <div id="listaLocais"></div>
  </div>

  <div id="movimentacao" class="guia">
    <h2>Movimentar Produto</h2>
    <select id="selectProduto" onchange="mostrarHistoricoMovimentacao()"></select>
    <select id="selectLocalOrigem"></select>
    <select id="selectLocalDestino"></select>
    <input id="quantidade" type="number" placeholder="Quantidade" min="1" />
    <button onclick="movimentarProduto()">Realizar Movimentação</button>
    <pre id="historicoProduto"></pre>
  </div>

  <div id="estoque" class="guia">
    <h2>Estoque Atual</h2>
    <div id="estoqueConteudo"></div>
  </div>

  <div id="relatorio" class="guia">
    <h2>Relatório</h2>
    <button onclick="gerarRelatorio()">Gerar Relatório</button>
    <button onclick="gerarPDF()">Baixar PDF</button>
    <pre id="relatorioTexto"></pre>
  </div>

<script>
  // Dados iniciais carregados do localStorage
  let produtos = JSON.parse(localStorage.getItem("produtos") || "[]");
  let locais = JSON.parse(localStorage.getItem("locais") || "[]");

  // Salva dados no localStorage
  function salvarDados() {
    localStorage.setItem("produtos", JSON.stringify(produtos));
    localStorage.setItem("locais", JSON.stringify(locais));
  }

  // Mostra guia selecionada
  function mostrarGuia(id) {
    document.querySelectorAll(".guia").forEach(div => div.classList.remove("ativa"));
    document.getElementById(id).classList.add("ativa");
  }

  // Atualiza selects com produtos e locais
  function atualizarSelects() {
    const selectProduto = document.getElementById("selectProduto");
    const selectLocalOrigem = document.getElementById("selectLocalOrigem");
    const selectLocalDestino = document.getElementById("selectLocalDestino");
    const localInicial = document.getElementById("localInicial");

    [selectProduto].forEach(select => {
      select.innerHTML = "";
      produtos.forEach(prod => {
        const opt = document.createElement("option");
        opt.value = prod.codigo;
        opt.textContent = `${prod.codigo} - ${prod.nome}`;
        select.appendChild(opt);
      });
    });

    [selectLocalOrigem, selectLocalDestino, localInicial].forEach(select => {
      select.innerHTML = "";
      locais.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc.nome;
        opt.textContent = `${loc.nome} - ${loc.endereco}`;
        select.appendChild(opt);
      });
    });
  }

  // Exporta dados para arquivo JSON
  function exportarDados() {
    const dados = { produtos, locais };
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "estoque_dados.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Importa dados de arquivo JSON
  function importarDados() {
    const fileInput = document.getElementById("importarArquivo");
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const dados = JSON.parse(event.target.result);
        if (!dados.produtos || !dados.locais) throw new Error("Formato inválido.");
        produtos = dados.produtos;
        locais = dados.locais;
        salvarDados();
        atualizarSelects();
        mostrarProdutos();
        mostrarLocais();
        mostrarEstoque();
        alert("Dados importados com sucesso.");
      } catch (e) {
        alert("Erro ao importar dados: " + e.message);
      }
    };
    reader.readAsText(file);
  }

  // Cadastra novo produto
  function cadastrarProduto() {
    const codigo = document.getElementById("codigoProduto").value.trim();
    const nome = document.getElementById("nomeProduto").value.trim();
    const quantidadeInicial = parseInt(document.getElementById("quantidadeInicial").value, 10);
    const localInicial = document.getElementById("localInicial").value;

    if (!codigo || !nome || isNaN(quantidadeInicial) || quantidadeInicial < 0 || !localInicial) {
      alert("Preencha todos os campos corretamente.");
      return;
    }

    if (produtos.find(p => p.codigo === codigo)) {
      alert("Código do produto já cadastrado.");
      return;
    }

    const novoProduto = {
      codigo,
      nome,
      estoque: {
        [localInicial]: quantidadeInicial
      },
      movimentacoes: []
    };

    produtos.push(novoProduto);
    salvarDados();
    atualizarSelects();
    mostrarProdutos();

    document.getElementById("codigoProduto").value = "";
    document.getElementById("nomeProduto").value = "";
    document.getElementById("quantidadeInicial").value = "";
  }

  // Mostra lista de produtos cadastrados
  function mostrarProdutos() {
    const lista = document.getElementById("listaProdutos");
    lista.innerHTML = "";

    if (produtos.length === 0) {
      lista.textContent = "Nenhum produto cadastrado.";
      return;
    }

    produtos.forEach(prod => {
      const div = document.createElement("div");
      div.className = "produto";
      const estoqueLocal = Object.entries(prod.estoque).map(([loc, qtd]) => `${loc}: ${qtd}`).join(", ");

      div.innerHTML = `
        <strong>${prod.codigo} - ${prod.nome}</strong><br>
        Estoque: ${estoqueLocal}
        <button onclick="excluirProduto('${prod.codigo}')">Excluir</button>
      `;

      lista.appendChild(div);
    });
  }

  // Exclui produto pelo código
  function excluirProduto(codigo) {
    if (!confirm("Confirma exclusão do produto?")) return;
    produtos = produtos.filter(p => p.codigo !== codigo);
    salvarDados();
    atualizarSelects();
    mostrarProdutos();
    mostrarEstoque();
  }

  // Cadastra novo local
  function cadastrarLocal() {
    const nome = document.getElementById("nomeLocal").value.trim();
    const endereco = document.getElementById("enderecoLocal").value.trim();

    if (!nome || !endereco) {
      alert("Preencha todos os campos corretamente.");
      return;
    }

    if (locais.find(l => l.nome === nome)) {
      alert("Local já cadastrado.");
      return;
    }

    locais.push({ nome, endereco });
    salvarDados();
    atualizarSelects();
    mostrarLocais();

    document.getElementById("nomeLocal").value = "";
    document.getElementById("enderecoLocal").value = "";
  }

  // Mostra lista de locais cadastrados
  function mostrarLocais() {
    const lista = document.getElementById("listaLocais");
    lista.innerHTML = "";

    if (locais.length === 0) {
      lista.textContent = "Nenhum local cadastrado.";
      return;
    }

    locais.forEach((loc, i) => {
      const div = document.createElement("div");
      div.className = "local";

      div.innerHTML = `
        <strong>${loc.nome} - ${loc.endereco}</strong>
        <button onclick="excluirLocal(${i})">Excluir</button>
      `;

      lista.appendChild(div);
    });
  }

  // Exclui local pelo índice
  function excluirLocal(i) {
    if (!confirm("Confirma exclusão do local?")) return;

    // Verificar se algum produto tem estoque nesse local
    const localNome = locais[i].nome;
    for (const prod of produtos) {
      if (prod.estoque[localNome] && prod.estoque[localNome] > 0) {
        alert(`Não é possível excluir. Produto ${prod.codigo} possui estoque nesse local.`);
        return;
      }
    }

    locais.splice(i, 1);
    salvarDados();
    atualizarSelects();
    mostrarLocais();
  }

  // Realiza movimentação de produtos entre locais
  function movimentarProduto() {
    const codigoProduto = document.getElementById("selectProduto").value;
    const localOrigem = document.getElementById("selectLocalOrigem").value;
    const localDestino = document.getElementById("selectLocalDestino").value;
    const quantidade = parseInt(document.getElementById("quantidade").value, 10);

    if (!codigoProduto || !localOrigem || !localDestino || isNaN(quantidade) || quantidade <= 0) {
      alert("Preencha todos os campos corretamente.");
      return;
    }

    if (localOrigem === localDestino) {
      alert("Local de origem e destino devem ser diferentes.");
      return;
    }

    const produto = produtos.find(p => p.codigo === codigoProduto);
    if (!produto) {
      alert("Produto não encontrado.");
      return;
    }

    const estoqueOrigem = produto.estoque[localOrigem] || 0;
    if (estoqueOrigem < quantidade) {
      alert("Quantidade insuficiente no local de origem.");
      return;
    }

    // Atualiza estoque
    produto.estoque[localOrigem] = estoqueOrigem - quantidade;
    produto.estoque[localDestino] = (produto.estoque[localDestino] || 0) + quantidade;

    // Registra movimentação
    const mov = {
      data: new Date().toLocaleString(),
      origem: localOrigem,
      destino: localDestino,
      quantidade
    };
    produto.movimentacoes.push(mov);

    salvarDados();
    mostrarHistoricoMovimentacao();
    mostrarEstoque();
    mostrarProdutos();

    document.getElementById("quantidade").value = "";
  }

  // Mostra histórico de movimentações do produto selecionado
  function mostrarHistoricoMovimentacao() {
    const codigoProduto = document.getElementById("selectProduto").value;
    const historico = document.getElementById("historicoProduto");

    const produto = produtos.find(p => p.codigo === codigoProduto);
    if (!produto || !produto.movimentacoes.length) {
      historico.textContent = "Nenhuma movimentação.";
      return;
    }

    let texto = "";
    produto.movimentacoes.forEach((mov, i) => {
      texto += `${i + 1}. ${mov.data} | ${mov.quantidade} unidades | ${mov.origem} → ${mov.destino}\n`;
    });

    historico.textContent = texto;
  }

  // Mostra estoque atual de todos os produtos e locais
  function mostrarEstoque() {
    const div = document.getElementById("estoqueConteudo");
    div.innerHTML = "";

    if (produtos.length === 0 || locais.length === 0) {
      div.textContent = "Cadastre produtos e locais para ver o estoque.";
      return;
    }

    const tabela = document.createElement("table");
    tabela.border = "1";
    tabela.style.borderCollapse = "collapse";
    tabela.style.width = "100%";

    // Cabeçalho
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    trHead.innerHTML = "<th>Produto</th>";
    locais.forEach(loc => {
      const th = document.createElement("th");
      th.textContent = loc.nome;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    tabela.appendChild(thead);

    // Corpo
    const tbody = document.createElement("tbody");
    produtos.forEach(prod => {
      const tr = document.createElement("tr");
      const tdProduto = document.createElement("td");
      tdProduto.textContent = `${prod.codigo} - ${prod.nome}`;
      tr.appendChild(tdProduto);

      locais.forEach(loc => {
        const td = document.createElement("td");
        td.style.textAlign = "center";
        td.textContent = prod.estoque[loc.nome] || 0;
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    tabela.appendChild(tbody);
    div.appendChild(tabela);
  }

  // Gera relatório textual de estoque e movimentações
  function gerarRelatorio() {
    let texto = "";

    if (produtos.length === 0) {
      texto = "Nenhum produto cadastrado.";
      document.getElementById("relatorioTexto").textContent = texto;
      return;
    }

    produtos.forEach(prod => {
      texto += `Produto: ${prod.codigo} - ${prod.nome}\n`;
      texto += `Estoque por local:\n`;
      for (const [loc, qtd] of Object.entries(prod.estoque)) {
        texto += `  ${loc}: ${qtd}\n`;
      }
      if (prod.movimentacoes.length) {
        texto += `Movimentações:\n`;
        prod.movimentacoes.forEach((mov, i) => {
          texto += `  ${i + 1}. ${mov.data} | ${mov.quantidade} unidades | ${mov.origem} → ${mov.destino}\n`;
        });
      } else {
        texto += "Nenhuma movimentação.\n";
      }
      texto += "\n";
    });

    document.getElementById("relatorioTexto").textContent = texto;
  }

  // Gera PDF do relatório usando jsPDF
  function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const texto = document.getElementById("relatorioTexto").textContent || "Gere o relatório primeiro.";

    const linhas = texto.split("\n");
    let y = 10;

    doc.setFontSize(12);
    linhas.forEach(linha => {
      if (y > 280) { // quebra de página
        doc.addPage();
        y = 10;
      }
      doc.text(linha, 10, y);
      y += 7;
    });

    doc.save("relatorio_estoque.pdf");
  }

  // Inicializa interface
  mostrarGuia("produtos");
  atualizarSelects();
  mostrarProdutos();
  mostrarLocais();
  mostrarEstoque();
</script>
</body>
</html>
